<!DOCTYPE html>
<html>
<head><meta charset="UTF-8">
    <title>Статистика по студентам и командам</title>
    <link href="footable-bootstrap.latest/css/footable.bootstrap.min.css" rel="stylesheet">
    <script src="jquery.min.js"></script>
    <script src="footable-bootstrap.latest/js/footable.min.js"></script>
    <style>
        .footable-sortable{
            cursor: pointer;
        }
        .footable-sortable:hover .fooicon-sort{
            opacity: 1;
        }
        .fooicon-sort{
            opacity: 0;
        }
        .fooicon-sort:after{
            content: "\21c5";
        }
        .fooicon-sort-asc:after{
            content: "\21ca";
        }
        .fooicon-sort-desc:after{
            content: "\21c8";
        }
    </style>
</head>
<body>
<a href="persons.html">Статистика по сотрудникам</a><br/>
<a href="projects.html">Статистика по командам/проектам</a><br/>
<select id="selectProject" onready="getProjects(true)" onchange="getSprints(true)">



</select>
<select id="selectSprint">
    <option id='88' num='0'>Спринт 8. Шаблоны</option>
    <option id='87' num='1'>Спринт 7 доделка SSL</option>
    <option id='86' num='2'>Спринт 6. SSL и т.д.</option>
    <option id='85' num='3'>Спринт 5</option>
    <option id='84' num='4'>Спринт 4. Расширенные настройки сайта.</option>
    <option id='83' num='5'>Спринт 3. Настройки и создание сайта</option>
    <option id='82' num='6'>Спринт 2</option>

</select>
<button class="button" onclick="sendRequest()">Поиск</button>
<table class="table table-striped" id="myTable" data-paging="true" cellspacing="0" border="1" data-sorting="true">

    <thead><tr>
        <td></td>
        <td></td>
        <td colspan="4">Завершено</td>
        <td colspan="3">Не завершено</td>
        <td colspan="4">Помощь</td>
        <td colspan="6">Код</td>
    </tr>
    <tr>
        <td>Имя</td>
        <td data-type="date">Время работы</td>
        <td>Задач</td>
        <td data-type="date">План</td>
        <td>Факт</td>
        <td>Оценка</td>
        <td>Задач</td>
        <td>План</td>
        <td>Факт</td>
        <td>Закончено -время</td>
        <td>Закончено</td>
        <td>В работе -время</td>
        <td>В работе</td>
        <td>Возвраты</td>
        <td>Замечания</td>
        <td>Ветки</td>
        <td>Слияния</td>
        <td>Просмотры</td>
        <td>Комментарии</td>
    </tr>
    </thead>
    <tbody>

    </tbody>
</table>
<script>
    function getSprints(b){
        var httpRequest;
        if(window.XMLHttpRequest){ //Mozilla, Safari
            httpRequest=new XMLHttpRequest();
        } else if(Window.ActiveXObject){ //IE
            httpRequest=new ActiveXObject('Microsoft.XMLHTTP');
        }
        httpRequest.overrideMimeType('text/ajax');
        httpRequest.onload=function() {
            $('#selectSprint option').remove();
            var sprints=JSON.parse(this.response);
            var a=0;
            sprints.forEach(function(item,i,arr){
                $('#selectSprint').append('<option id=\''+item.sprintID+'\' num='+a+'>'+item.name+'</option>');
                a++;
            });
        }
        var select=document.getElementById('selectProject');
        var arg = select.options.item(select.options.selectedIndex).getAttribute('id');
        httpRequest.open('GET', 'http://127.0.0.1:8080/getSprintsForProject/'+arg, b);
        httpRequest.send(null);
    }
    function getProjects(){
        var httpRequest;
        if(window.XMLHttpRequest){ //Mozilla, Safari
            httpRequest=new XMLHttpRequest();
        } else if(Window.ActiveXObject){ //IE
            httpRequest=new ActiveXObject('Microsoft.XMLHTTP');
        }
        httpRequest.overrideMimeType('text/ajax');
        httpRequest.onload=function() {
            $('#selectProject option').remove();
            var sprints=JSON.parse(this.response);
            var a=0;
            sprints.forEach(function(item,i,arr){
                $('#selectProject').append('<option id=\''+item.projectID+'\' num='+a+'>'+item.name+'</option>');
                a++;
            });
        }
        httpRequest.open('GET', 'http://localhost:8080/getProjects', true);
        httpRequest.send(null);
    }
    function sendRequest(){
        var httpRequest;
        if(window.XMLHttpRequest){ //Mozilla, Safari
            httpRequest=new XMLHttpRequest();
        } else if(Window.ActiveXObject){ //IE
            httpRequest=new ActiveXObject('Microsoft.XMLHTTP');
        }
        httpRequest.overrideMimeType('text/ajax');
        httpRequest.onload=function() {
            $('#myTable tbody tr').remove();
            var data=JSON.parse(this.response);
            data.forEach(function(item,i,arr){
                var ratio=(item.completeFactTime/item.completeEstTime).toFixed(2);
                if(isNaN(ratio) || ratio==Infinity) ratio=0;
                var days=Math.floor(item.workTime/28800);
                var hour=Math.floor((item.workTime % 28800) / 3600);
                var min=Math.floor(((item.workTime % 28800) % 3600) / 60);
                var workTime=days>0?
                    days+'d '+ (hour<10?('0'+hour):hour) + ':' + (min<10?('0'+min):min):
                    (hour<10?('0'+hour):hour) + ':' + (min<10?('0'+min):min);
                $('#myTable tbody').append('<tr><td><a href=\'persons.html/'+item.personID+'\'>'+item.person+'</a></td>' +
                    '<td data-sort-value=\''+item.workTime+'\' align=\'right\'>'+ workTime +'</td>' +
                    '<td data-sort-value=\''+item.completeCount+'\'>'+item.completeCount+'</td>' +
                    '<td data-sort-value=\''+item.completeEstTime+'\' align=\'right\'>'+getDateString(item.completeEstTime)+'</td>' +
                    '<td data-sort-value=\''+item.completeFactTime+'\' align=\'right\'>'+getDateString(item.completeFactTime)+'</td>' +
                    '<td data-sort-value=\''+ratio+'\'>'+ratio+'</td>' +
                    '<td data-sort-value=\''+item.incompleteCount+'\'>'+item.incompleteCount+'</td>' +
                    '<td data-sort-value=\''+item.incompleteEstTime+'\' align=\'right\'>'+getDateString(item.incompleteEstTime)+'</td>' +
                    '<td data-sort-value=\''+item.incompleteFactTime+'\' align=\'right\'>'+getDateString(item.incompleteFactTime)+'</td>' +
                    '<td data-sort-value=\''+item.completeHelpTime+'\' align=\'right\'>'+getDateString(item.completeHelpTime)+'</td>' +
                    '<td data-sort-value=\''+item.completeHelpCount+'\'>'+item.completeHelpCount+'</td>' +
                    '<td data-sort-value=\''+item.incompleteHelpTime+'\' align=\'right\'>'+getDateString(item.incompleteHelpTime)+'</td>' +
                    '<td data-sort-value=\''+item.incompleteHelpCount+'\'>'+item.incompleteHelpCount+'</td>' +
                    '<td data-sort-value=\''+item.codeReturns+'\'>'+item.codeReturns+'</td>' +
                    '<td data-sort-value=\''+item.codeDiscussion+'\'>'+item.codeDiscussion+'</td>' +
                    '<td data-sort-value=\''+item.codeBranches+'\'>'+item.codeBranches+'</td>' +
                    '<td data-sort-value=\''+item.codeMerged+'\'>'+item.codeMerged+'</td>' +
                    '<td data-sort-value=\''+item.codeSeen+'\'>'+item.codeSeen+'</td>' +
                    '<td data-sort-value=\''+item.codeCommented+'\'>'+item.codeCommented+'</td></tr>');
            });
            function getDateString(sec){
                var days=Math.floor(sec/480);
                var hour=Math.floor((sec % 480) / 60);
                var min=Math.floor((sec % 480) % 60);
                return days>0?
                    days+'d '+ (hour<10?('0'+hour):hour) + ':' + (min<10?('0'+min):min):
                    (hour<10?('0'+hour):hour) + ':' + (min<10?('0'+min):min);
            }
            function getInfoForPerson(id){
                location.href='persons.jsp';
                $('#selectPerson').items.setSelected(id);
            }
            $('#myTable').footable();
            FooTable.get('#myTable').pageSize(15);
        }
        var select=document.getElementById('selectSprint');
        var arg = select.options.item(select.options.selectedIndex).getAttribute('id');
        httpRequest.open('GET', 'http://localhost:8080/getJobsForSprint/'+arg, true);
        httpRequest.send(null);
    };
    //это код для перехода из других таблиц по жмакабельным названиям спринта
    var id=window.location.search.substring(7);
    if(id) {
        var httpRequest;
        if(window.XMLHttpRequest){ //Mozilla, Safari
            httpRequest=new XMLHttpRequest();
        } else if(Window.ActiveXObject){ //IE
            httpRequest=new ActiveXObject('Microsoft.XMLHTTP');
        }
        httpRequest.overrideMimeType('text/ajax');
        httpRequest.onload=function() {
            //переключить на проект
            var data=JSON.parse(this.response);
            var select = document.getElementById('selectProject');
            //найти элемент с нужным индексом (они были отсортированы, id в базе и индекс в списке не совпадают)
            var index=document.getElementById('project'+data).getAttribute("num");
            select.selectedIndex=Number(index);
            getSprints(false);

            //переключить на спринт
            var select = document.getElementById('selectSprint');
            //найти элемент с нужным индексом (они были отсортированы, id в базе и индекс в списке не совпадают)
            var index = document.getElementById(id).getAttribute('num');
            select.selectedIndex = Number(index);
            //вывод информации о спринте
            sendRequest();
        }
        httpRequest.open('GET', 'http://127.0.0.1:8888/getProjectForSprint?index='+id, true);
        httpRequest.send(null);

    }
</script>
<script>getProjects()</script>
</body></html>